<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <link type="text/css" rel="stylesheet" href="../css/common/header.css">
  <link type="text/css" rel="stylesheet" href="../css/common/common.css">
  <link type="text/css" rel="stylesheet" href="../css/materials/receivings.css">
  <link type="text/css" rel="stylesheet" href="../css/common/sidebar.css">
    <script type="text/javascript" src="../js/sidebar.js"></script>
  <title>자재입고</title>
</head>
<body>
  <div th:insert="~{/common/sidebar :: sidebar}"></div>
  		<div th:insert="~{/common/header :: header}"></div>
	<div class="main-content">

		<div id="row2">
    <div id="planList">
      <h2 class="visual-title">입고예정품목</h2>
<!--       <div class="search-container">
        <label for="dateInput"></label>
        <input type="date" id="dateInput">

        드롭다운 메뉴로 필터 선택
        <select id="filterSelect">
            <option value="itemCode">품목코드</option>
            <option value="itemName">품목명</option>
        </select>
        검색 입력 필드
        <input type="text" id="searchInput" placeholder="검색어를 입력하세요">
        검색 버튼
        <button onclick="performSearch()" class="blueBtn">검색</button>
      </div> -->

      <table class="list-table" id="res">
        <colgroup>
          <col width="11%">
          <col width="11%">
          <col width="10%">
          <col width="7%">
          <col width="7%">
          <col width="7%">
          <col width="7%">
          <col width="7%">
          <col width="5%">
        </colgroup>
        <tr>
          <th> 품목코드</th>
          <th> 품목명</th>
          <th> 재질</th>
          <th> 입고수량</th>
          <th> 발주수량</th>
          <th> 발주일</th>
          <th> 납기일</th>
          <th> 입고마감일</th>
          <th> 현황</th>
        </tr>
        <th:block th:each="receiving : ${receivingsP}">
        <tr>
          <td>
            <input type="hidden" class="receiving-number" th:value="${receiving.receiveNumber}">
            <span th:text="${receiving.orders.contract.item.itemCode}"></span>
          </td>
          <td th:text="${receiving.orders.contract.item.itemName}"></td>
          <td th:text="${receiving.orders.contract.item.material}"></td>
          <td th:text="${receiving.receiveQuantity}"></td> 
          <td th:text="${receiving.orders.orderQuantity}"></td> <!-- 발주서.발주수량 가져오기 // 수정필요! -->
          <td th:text="${receiving.orders.orderDate}"></td>
          <td th:text="${receiving.orders.contract.lead_time}"></td>  <!-- 계약 : 납기일 -->
          <td th:text="${receiving.receiveDate}"></td>
          <td th:if="${receiving.receiveClosingYn} == 'Y'">
          	<input type="button" value="마감" class="blueBtn">
          </td>
          <td th:if="${receiving.receiveClosingYn} == 'N'">
   			  <input type="button" data-ono="${receiving.orders.orderNo}"  value="입고" class="blueBtn" th:onclick="receivingStrat(this)">
          </td>
        </tr>
        </th:block>
      </table>  
    </div>
    <div class="paging-wrap">
			    <ul class="pagination">
			        <!-- 이전 페이지 링크 -->
			        <li th:if="${receivingsP.hasPrevious()}">
			            <a th:href="@{/receivings(page=${receivingsP.previousPageable().pageNumber})}">이전</a>
			        </li>
			        
			        <!-- 페이지 번호 링크 -->
			        <th:block th:with="startPage=${receivingsP.number - 4 >= 0 ? receivingsP.number - 4 : 0},
			                    endPage=${receivingsP.number + 4 < receivingsP.totalPages ? receivingsP.number + 4 : receivingsP.totalPages - 1}">
			            <li th:each="i : ${#numbers.sequence(startPage, endPage)}">
			                <a th:href="@{/receivings(page=${i})}" th:classappend="${i == receivingsP.number} ? 'active' : ''" th:text="${i + 1}">Page number</a>
			            </li>
			        </th:block>
			        
			        <!-- 다음 페이지 링크 -->
			        <li th:if="${receivingsP.hasNext()}">
			            <a th:href="@{/receivings(page=${receivingsP.nextPageable().pageNumber})}">다음</a>
			        </li>
			    </ul>
			</div>
  </div>
  
  
    <div id="row1">
    <form action="saveReceiving" method="post" onsubmit="return confirmReceiving()">
	      <h2 class="visual-title">자재입고</h2>
	       <div class="btn-container">
	        <button type="submit" class="blueBtn" id="save">저장</button>
	        <button type="button" class="blueBtn" id="end" onclick='return endRecieving(this.form)'>마감</button>
	      </div>
	       <table class="regi-table" id="receivingTable">
	        <colgroup>
	          <col width="20%">
	          <col width="25%">
	          <col width="20%">
	          <col width="20%">
	          <col width="10%">
	        </colgroup>
	        <tr>
	          <th> 품목코드</th>
	          <th> 품목명</th>
	          <th> 입고수량</th>
	          <th> 발주수량</th>
	          <th> 입고수량</th>
	        </tr>
			<tr>
			  <td></td>
			  <td></td>  <!--히든인풋으로 발주번호저장  -->
			  <td></td><!-- 기입고량 -->
			  <td></td> <!-- 발주량 -->
			  <td>
			    <input type="hidden" id="receiveNumber" name="receiveNumber"> <!-- 입고번호 -->
		
			    <input type="number" id="quantity" name="quantity" ><!-- 입고량 -->
			  </td>
			</tr>		
	      </table>  
      </form>
    </div>
    
    
     <div id="row2">
        <h2 class="visual-title">입고내역</h2>
        
		<div class="search-container">
			<form id="searchForm">	
				<div class="search-bar">
					<select id="filterSelect">
						<option value="0">발주번호</option>
						<option value="1">품목코드</option>
						<option value="2">품목명</option>
						<option value="3">입고일</option>
					</select>
					<input type="text" id="searchInput2" placeholder="검색어를 입력하세요">
					<button onclick="performSearch()" class="blueBtn">검색</button>
				 </div>
			 </form>
			
	       <table class="regi-table" id="receivingTable">
	        <colgroup>
	          <col width="18%">
	          <col width="18%">
	          <col width="18%">
	          <col width="18%">
	          <col width="18%">
	          <col width="18%">
	        </colgroup>
	        <tr>
	          <th> 발주번호</th>
	          <th> 품목코드</th>
	          <th> 품목명</th>
	          <th> 입고일</th>
	          <th> 발주수량</th>
	          <th> 입고수량</th>
	        </tr>
			<tr th:each="receiveList : ${receiveListsP.content}" >
			    <td th:text="${receiveList.receiving.orders.orderNo}"></td>
			    <td th:text="${receiveList.receiving.orders.contract.item.itemCode}"></td>
			    <td th:text="${receiveList.receiving.orders.contract.item.itemName}"></td>
			    <td th:text="${receiveList.sysdate}"></td>
			    <td th:text="${receiveList.receiving.orders.orderQuantity}"></td>
			    <td th:text="${receiveList.quantity}"></td>
			</tr>
	      </table>  
	      
	      
			<div class="paging-wrap">
			    <ul class="pagination">
			        <!-- 이전 페이지 링크 -->
			        <li th:if="${receiveListsP.hasPrevious()}">
			            <a th:href="@{/receivings(page=${receiveListsP.previousPageable().pageNumber})}">이전</a>
			        </li>
			        
			        <!-- 페이지 번호 링크 -->
			        <th:block th:with="startPage=${receiveListsP.number - 4 >= 0 ? receiveListsP.number - 4 : 0},
			                    endPage=${receiveListsP.number + 4 < receiveListsP.totalPages ? receiveListsP.number + 4 : receiveListsP.totalPages - 1}">
			            <li th:each="i : ${#numbers.sequence(startPage, endPage)}">
			                <a th:href="@{/receivings(page=${i})}" th:classappend="${i == receiveListsP.number} ? 'active' : ''" th:text="${i + 1}">Page number</a>
			            </li>
			        </th:block>
			        
			        <!-- 다음 페이지 링크 -->
			        <li th:if="${receiveListsP.hasNext()}">
			            <a th:href="@{/receivings(page=${receiveListsP.nextPageable().pageNumber})}">다음</a>
			        </li>
			    </ul>
			</div>
	   </div> <!-- search-container -->
	 </div><!-- row2  -->
</div> <!-- main-content-->
	
	
	
  <script>
  
  //입고창으로 값 가져옴
  
  	function receivingStrat(button){
  		 
	  
  		var row = button.parentElement.parentElement;  //부모태그의 부모태그를 반환(td -> tr!)
  		var receivingNumber = row.querySelector('.receiving-number').value; //입고번호(pk)
        var itemCode = row.cells[0].children[1].innerText; //품목코드
        var itemName = row.cells[1].innerText; //품목네임
        var wQuantity = row.cells[3].innerText; //입고수량
        var orderedQuantity = row.cells[4].innerText; //발주수량
        
  
  		var receivingTable = document.getElementById("receivingTable"); //하단 테이블(자재입고) 찾음
	  	var firstRow = receivingTable.rows[1]; // 첫 번째 데이터 행을 참조
	  	
	      var receivingNumbers = row.getElementsByClassName('receiving-number');
	      var receiveNum  = receivingNumbers[0].value;
	  	  //입고번호 가져오려고 발악함 [0]셀
	  	  
	  	  if(orderedQuantity == wQuantity){
	  		  document.getElementById("save").style.display = "none";
	  		document.getElementById("end").style.display = "block";
	  	  }else{
	  		  document.getElementById("save").style.display = "block";
		  		document.getElementById("end").style.display = "none";
	  	  }
	  	  
	  	  console.log(receiveNum);
	  	  
	  	   firstRow.cells[0].innerHTML = '<input type="hidden" name="receivingNumber" value="' + receivingNumber + '">' + itemCode;
	      firstRow.cells[1].innerText =  itemName;
	      firstRow.cells[2].innerHTML = '<input type="hidden" name="wQuantity"  id="wQuantity" value="' + wQuantity + '">' + wQuantity;
	      firstRow.cells[3].innerHTML = '<input type="hidden" name="orderQuantity" id="orderQuantity" value="' + orderedQuantity + '">' + orderedQuantity;
	      firstRow.cells[4].innerHTML = '<input type="number" name="quantity" id="quantity" value="' + orderedQuantity + '">';
	      
	 }
   
  	function confirmReceiving() {
  		var Value1 = parseInt(document.getElementById("quantity").value);
  		var Value2 = parseInt(document.getElementById("orderQuantity").value);
  		var Value3 = parseInt(document.getElementById("wQuantity").value);
  		console.log(typeof inputValue1); // inputValue1 변수의 타입을 출력합니다.
  		console.log(typeof inputValue2); // inputValue2 변수의 타입을 출력합니다.
  		console.log(typeof inputValue3); // inputValue3 변수의 타입을 출력합니다.
  	    // 사용자에게 확인 메시지 표시
  	    
  	    //유요성 체크.. 
  	    if(Value2 == Value3){
  	    	alert('마감을 진행하세요.');
  	    	return false;
  	    }else if(Value2 >= Value1 + Value3 ){
  			var confirmed = confirm('저장 하시겠습니까?');
  			if(confirmed){
  				return true;
  			}else false;
  		}else if(Value2 < Value1 + Value3){
  			alert('입고량을 확인하세요.');

  			document.getElementById("quantity").focus();
  			document.getElementById("quantity").value = Value2 - Value3;
  			return false;
  		}  
  	    

  	    // 사용자가 확인을 선택했을 경우 true를 반환하여 폼이 제출되도록 함
  	    return confirmed;
  	}
  	
  	
	//마감처리
	function endRecieving(frm){
		var Value2 = parseInt(document.getElementById("orderQuantity").value);
  		var Value3 = parseInt(document.getElementById("wQuantity").value);
  	    
  	    
		if(Value2 == Value3){
			var confrmation = confirm("입고를 마감하시겠습니까?");
			
			if(confrmation){
				frm.action='endRecieving';
				frm.submit();
				return true;
			}else alert("취소하였습니다.");
		}else{
			alert("입고 완료 후 마감하세요");
			document.getElementById("quantity").focus();
			return false;
		}
		
	}
	     
	  
  </script>  


  <script>
  function performSearch() {
	    var filter = document.getElementById('filterSelect').value; // 필터 값을 가져옴
	    var searchText = document.getElementById('searchInput2').value.trim(); // 검색어 값을 가져옴
	    
	    var tableRows = document.querySelectorAll('#row2 table tr'); // 수정된 부분
	    
	    tableRows.forEach(function(row) { // 각 행에 대해 반복
	        if (!row.querySelector('th')) {  // th가 아닌 행만 처리
	            // 검색 대상 열을 선택할 때 필터 값을 사용하여 수정
	            var columnIndex = parseInt(filter) + 1;
	            var searchTarget = row.querySelector('td:nth-child(' + columnIndex + ')').textContent;
	            if (searchTarget.includes(searchText)) {
	                row.style.display = 'table-row';
	            } else {
	                row.style.display = 'none';
	            }
	        }
	    });
	}
    </script>
</body>
</html>