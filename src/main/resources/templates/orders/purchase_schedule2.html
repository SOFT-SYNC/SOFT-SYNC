<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link type="text/css" rel="stylesheet" href="../css/common/header.css">
<link type="text/css" rel="stylesheet" href="../css/common/common.css">
<link type="text/css" rel="stylesheet" href="../css/common/sidebar.css">
<link type="text/css" rel="stylesheet" href="../css/orders/purchase_schedule.css">
<script type="text/javascript" src="../js/sidebar.js"></script>
</head>
<body>
   <div th:insert="~{common/sidebar :: sidebar}"></div>
   <div th:insert="~{common/header :: header}"></div>
   <div class="main-content">
      <div id="row1">
         <div id="toptb">
            <h1 class="visual-title">진척검수</h1>
            <table class="table" id="mainTable">
               <colgroup>
               </colgroup>
               <thead>
                  <tr>
                     <th>발주번호</th>
                     <th>발주일</th>
                     <th>입고예정일</th>
                     <th>품목코드</th>
                     <th>품명</th>
                     <th>발주수량</th>
                  </tr>
                  <tr>
                  	<td>발주번호</td>
                    <td>발주일</td>
                    <td>입고예정일</td>
                    <td>품목코드</td>
                    <td>품명</td>
                    <td>발주수량</td>
                  </tr>
               </thead>
               <tbody>
                 
               </tbody>
            </table>
            <table class="inspecPlanList table" id="createtb">
               <thead>
                  <tr>
                     <th>차수</th>
                     <th>검수예정일</th>
                     <th>검수일</th>
                     <th>발주량</th>
                     <th>생산량</th>
                     <th>진행률</th>
                     <th>비고</th>
                     <th>진행</th>
                  </tr>
               </thead>
               <tbody>
               </tbody>
            </table>
            <h2 class="visual-title">진척검수 일정 등록</h2>
            <table class="inspecPlanRegi listTable">
               <tr>
                  <th>차수</th>
                  <th>검수예정일</th>
                  <th>생산량</th>
                  <th>등록 취소</th>
               </tr>
               <tr>
                  <td><input type="text" id="times" readonly disabled></td>
                  <td><input type="date" id="duedate"></td>
                  <td><input type="text" id="quantity"></td>
                  <td>
                     <button type="button"  class="blueBtn">등록</button>
                  </td>
               </tr>
            </table>
         </div>
      </div>
      <div id="row2">
         <h2 class="visual-title">검수 예정 품목</h2>
         <table class="listTable">
            <colgroup>
            <col width="12%">
            <col width="15%">
            <col width="15%">
            <col width="15%">
            <col width="13%">
            <col width="10%">
            <col width="10%">
            <col width="10%">
            </colgroup>
            <thead>
               <tr>
                  <th>발주번호</th>
                  <th>발주일</th>
                  <th>입고예정일</th>
                  <th>품목코드</th>
                  <th>품명</th>
                  <th>발주수량</th>
                  <th>검수현황</th>
                  <th>검수</th>
               </tr>
               <tr th:each="contract : ${contracts}" th:if="${contract.orders.size() > 0 && contract.orders[0].receiptYn == 'Y'}">
                  <td th:text="${contract.orders.size() > 0 ? contract.orders[0].orderNo : '-'}">발주번호</td>
                  <td th:text="${contract.orders.size() > 0 ? contract.orders[0].orderDate : '-'}">발주일</td>
                  <td th:text="${contract.lead_time}">납기일</td>
                  <td th:text="${contract.item.itemCode}">품목코드</td>
                  <td th:text="${contract.item.itemName}">품목명</td>
                  <td th:text="${contract.orders.size() > 0 ? contract.orders[0].orderQuantity : '-'}">N/A</td>
                  <td></td>
                  <td><input type="button" value="검수" class="blueBtn" onclick="addToMainTable(this)"></td>
               </tr>
            </thead>
         </table>
      </div>
   </div>
   
<script>
  
    function addToMainTable(button) {
        var row = button.closest("tr");
        var cells = row.cells;

        var 발주번호 = cells[0].innerText;
        var 발주일 = cells[1].innerText;
        var 입고예정일 = cells[2].innerText;
        var 품목코드 = cells[3].innerText;
        var 품명 = cells[4].innerText;
        var 발주수량 = cells[5].innerText;

        // 상단 테이블의 셀에 값을 설정
        document.getElementById("orderNoCell").innerText = 발주번호;
        document.getElementById("orderDateCell").innerText = 발주일;
        document.getElementById("LTDateCell").innerText = 입고예정일;
        document.getElementById("itemCodeCell").innerText = 품목코드;
        document.getElementById("itemNameCell").innerText = 품명;
        document.getElementById("orderQuantityCell").innerText = 발주수량;
    }
    function getMainTableOrderQuantity() {
        var table = document.getElementById("mainTable").getElementsByTagName("tbody")[0];
        var rows = table.getElementsByTagName("tr");
        var orderQuantity = "N/A";

        // 마지막 행에서 발주수량 가져오기
        if (rows.length > 0) {
            var lastRow = rows[rows.length - 1];
            orderQuantity = lastRow.cells[5].innerText;
        }

        return orderQuantity;
    }

    function register() {
        var 차수 = calculateNext차수();
        var 검수예정일 = document.getElementById("duedate").value;
        var 생산량 = document.getElementById("quantity").value;
        var 발주량 = document.getElementById("orderQuantityCell").value;

        if (!검수예정일) {
            alert("검수예정일을 입력하세요.");
            return;
        }
        if (!생산량) {
            alert("생산량을 입력하세요.");
            return;
        }

        var table = document.getElementById("createtb").getElementsByTagName("tbody")[0];
        var newRow = table.insertRow();

        var cell1 = newRow.insertCell(0);
        var cell2 = newRow.insertCell(1);
        var cell3 = newRow.insertCell(2);
        var cell4 = newRow.insertCell(3);
        var cell5 = newRow.insertCell(4);
        var cell6 = newRow.insertCell(5);
        var cell7 = newRow.insertCell(6);
        var cell8 = newRow.insertCell(7);

        cell1.innerText = 차수;
        cell2.innerText = 검수예정일;
        cell3.innerText = "";  // 검수일은 빈칸으로
        cell4.innerText = 발주량;  // 발주량은 mainTable에서 가져옴
        cell5.innerText = 생산량;
        cell6.innerText = "";  // 진행률은 빈칸으로
        cell7.innerText = "";  // 비고는 빈칸으로
        cell8.innerHTML = '<button type="button" class="blueBtn" onclick="markComplete(this)">완료</button> <button type="button" class="blueBtn" onclick="deleteRow(this)">삭제</button>';

        // Reset form fields
        document.getElementById("duedate").value = "";
        document.getElementById("quantity").value = "";
    }

    function calculateNext차수() {
        var table = document.getElementById("createtb").getElementsByTagName("tbody")[0];
        var rows = table.getElementsByTagName("tr");
        var max차수 = 0;

        for (var i = 0; i < rows.length; i++) {
            var 차수 = parseInt(rows[i].cells[0].innerText);
            if (차수 > max차수) {
                max차수 = 차수;
            }
        }

        return max차수 + 1;
    }

    function markComplete(button) {
        var row = button.closest("tr");
        var 발주량 = row.cells[3].innerText;
        var 생산량 = row.cells[4].innerText;

        if (!발주량 || !생산량) {
            alert("발주량 또는 생산량이 없습니다.");
            return;
        }

        var 진행률 = (parseInt(생산량) / parseInt(발주량)) * 100;
        row.cells[2].innerText = new Date().toISOString().split('T')[0];  // 현재 날짜
        row.cells[5].innerText = 진행률.toFixed(2) + "%";  // 진행률 계산
    }

    function deleteRow(button) {
        var row = button.closest("tr");
        row.parentElement.removeChild(row);
    }
</script>

 </body>
 </html>