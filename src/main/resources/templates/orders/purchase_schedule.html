<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link type="text/css" rel="stylesheet" href="../css/common/header.css">
<link type="text/css" rel="stylesheet" href="../css/common/common.css">
<link type="text/css" rel="stylesheet" href="../css/common/sidebar.css">
<link type="text/css" rel="stylesheet" href="../css/orders/purchase_schedule.css">
<script type="text/javascript" src="../js/sidebar.js"></script>
<script type="text/javascript">


   function addToMainTable(button) {
      let orderNo = button.closest('tr').querySelector('td').innerText;
      fetchInspections(orderNo);
   }

   function fetchInspections(orderNo) {
	    fetch(`/api/inspections`, {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json'
	        },
	        body: JSON.stringify({ orderNo })
	    })
	    .then(response => response.json())
	    .then(data => {
	        populateMainTable(data.order);
	        populateInspecPlanList(data.inspectionList);
		       console.log(data); //inspection
	    })
	    .catch(error => console.error('Error fetching inspections:', error));
	}

   function populateMainTable(order) {
	    const mainTableBody = document.querySelector('#mainTable tbody');
	    mainTableBody.innerHTML = ''; 
	    // 입고예정일 to yyyy-MM-dd
	    const receiveDuedate = new Date(order.receiveDuedate).toISOString().split('T')[0];
	    let row = `<tr>
	                <td>${order.orderNo}</td>
	                <td>${order.orderDate}</td>
	                <td>${receiveDuedate}</td>
	                <td>${order.item.itemCode}</td>
	                <td>${order.item.itemName}</td>
	                <td>${order.orderQuantity}</td>
	              </tr>`;
	    mainTableBody.innerHTML += row;
	}

	function populateInspecPlanList(inspectionList) {
	    const inspecPlanListBody = document.querySelector('#createtb tbody');
	    inspecPlanListBody.innerHTML = ''; 
	    inspectionList.forEach(inspectionList => {
	        let row = `<tr>
	                    <td>${inspectionList.times}</td>
	                    <td>${inspectionList.inspecPlan}</td>
	                    <td>${inspectionList.inspecDate || '-'}</td>
	                    <td>${inspectionList.orders.orderQuantity}</td>
	                    <td>${inspectionList.quantity}</td>
	                    <td>${inspectionList.progressRate || '진행률'}</td>
	                    <td><button type="button" class="blueBtn" onclick="markComplete(this)">진행</button></td>
	                  </tr>`;
	        inspecPlanListBody.innerHTML += row;
		    console.log(inspectionList);
	    });
	}


   function registerInspection() {
      let orderNo = document.querySelector('#mainTable tbody tr:first-child td:first-child').innerText;
      let times = document.querySelector('#times').value;
      let inspecPlan = document.querySelector('#duedate').value;
      let quantity = document.querySelector('#quantity').value;

      fetch(`/api/inspections/create`, {
         method: 'POST',
         headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
         },
         body: `orderNo=${orderNo}&inspecPlan=${inspecPlan}&quantity=${quantity}&times=${times}`
      })
      .then(response => response.json())
      .then(data => {
         alert('새로운 검수 계획이 등록되었습니다.');
         fetchInspections(orderNo);
      })
      .catch(error => console.error('Error registering inspection:', error));
   }
   
   document.querySelector('.addBtn').addEventListener('click', function() {
	    const orderNo = document.querySelector('#times').value;
	    const inspecPlan = document.querySelector('#duedate').value;
	    const quantity = document.querySelector('#quantity').value;
		console.log(orderNo);
	    fetch(`/api/inspections/create`, {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json'
	        },
	        body: JSON.stringify({ orderNo, inspecPlan, quantity })
	    })
	    .then(response => response.json())
	    .then(data => {
	        fetchInspections(orderNo); // 등록 후 테이블 업데이트
	    })
	    .catch(error => console.error('Error creating inspection:', error));
	});

  
   function markComplete(button) {
       var row = button.closest("tr");
       var 발주량 = row.cells[3].innerText;
       var 생산량 = row.cells[4].innerText;

       if (!발주량 || !생산량) {
           alert("발주량 또는 생산량이 없습니다.");
           return;
       }

       var 진행률 = (parseInt(생산량) / parseInt(발주량)) * 100;
       row.cells[2].innerText = new Date().toISOString().split('T')[0];  // 현재 날짜
       row.cells[5].innerText = 진행률.toFixed(2) + "%";  // 진행률 계산
   }

</script>
</head>
<body>
   <div th:insert="~{common/sidebar :: sidebar}"></div>
   <div th:insert="~{common/header :: header}"></div>
   <div class="main-content">
      <div id="row1">
      <form>
         <div id="toptb">
            <h1 class="visual-title">진척검수</h1>
            <button type="submit" class="blueBtn">검수내역저장</button>
            <table class="table" id="mainTable">
               <colgroup>
               </colgroup>
               <thead>
                  <tr>
                     <th>발주번호</th>
                     <th>발주일</th>
                     <th>입고예정일</th>
                     <th>품목코드</th>
                     <th>품명</th>
                     <th>발주수량</th>
                  </tr>
               </thead>
               <tbody>
               </tbody>
            </table>
            <table class="inspecPlanList table" id="createtb">
               <thead>
                  <tr>
                     <th>차수</th>
                     <th>검수예정일</th>
                     <th>검수일</th>
                     <th>발주량</th>
                     <th>생산량</th>
                     <th>진행률</th>
                     <!-- <th>비고</th> -->
                     <th>진행</th>
                  </tr>
               </thead>
               <tbody>
               </tbody>
            </table>
            <h2 class="visual-title">진척검수 일정 등록</h2>
            <table class="inspecPlanRegi listTable">
               <tr>
                  <th>차수</th>
                  <th>검수예정일</th>
                  <th>생산량</th>
                  <th>등록 취소</th>
               </tr>
               <tr>
                  <td><input type="number" id="times"></td>
                  <td><input type="date" id="duedate"></td>
                  <td><input type="text" id="quantity"></td>
                  <td>
                     <button type="button" class="addBtn blueBtn" onclick="registerInspection()">등록</button>
                  </td>
               </tr>
            </table>
         </div>
         </form>
      </div>
      <div id="row2">
         <h2 class="visual-title">검수 예정 품목</h2>
         <table class="listTable">
            <colgroup>
               <col width="12%">
               <col width="15%">
               <col width="15%">
               <col width="15%">
               <col width="13%">
               <col width="10%">
               <col width="10%">
               <col width="10%">
            </colgroup>
            <thead>
               <tr>
                  <th>발주번호</th>
                  <th>발주일</th>
                  <th>입고예정일</th>
                  <th>품목코드</th>
                  <th>품명</th>
                  <th>발주수량</th>
                  <th>검수현황</th>
                  <th>검수</th>
               </tr>
               <tr th:each="contract : ${contracts}" th:if="${contract.orders.size() > 0 && contract.orders[0].receiptYn == 'Y'}">
                  <td th:text="${contract.orders.size() > 0 ? contract.orders[0].orderNo : '-'}">발주번호</td>
                  <td th:text="${contract.orders.size() > 0 ? contract.orders[0].orderDate : '-'}">발주일</td>
                  <td th:text="${contract.lead_time}">납기일</td>
                  <td th:text="${contract.item.itemCode}">품목코드</td>
                  <td th:text="${contract.item.itemName}">품목명</td>
                  <td th:text="${contract.orders.size() > 0 ? contract.orders[0].orderQuantity : '-'}">N/A</td>
                  <td></td>
                  <td><input type="button" value="검수" class="blueBtn" onclick="addToMainTable(this)"></td>
               </tr>
            </thead>
         </table>
      </div>
   </div>
</body>
</html>
