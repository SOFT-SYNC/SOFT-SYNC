<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<link type="text/css" rel="stylesheet" href="../css/purchase_order.css">
<link type="text/css" rel="stylesheet" href="../css/header.css">
<link type="text/css" rel="stylesheet" href="../css/common.css">
<link type="text/css" rel="stylesheet" href="../css/sidebar.css">
  <script type="text/javascript" src="../js/sidebar.js"></script>
</head>
<body>
	<div th:insert="~{common/sidebar :: sidebar}"></div>
	<div class="main-content">
		<div th:insert="~{common/header :: header}"></div>
		<div id="row1">
		<h2 class="visual-title">구매발주서</h2>
		<form th:action="@{/saveOrders}" method="post" enctype="multipart/form-data">
		<div>
			<button type="submit" id="popupBtn" class="blueBtn">발주서 발행</button>
			<button type="reset" class="blueBtn">초기화</button>
		</div>
			<table class="table" id="1">
			<colgroup>
			<col width="10%">
			<col width="40%">
			<col width="10%">
			<col width="40%">
			</colgroup>
			<tbody>
                  <tr>
                     <th>발주번호</th>
                     <td><input type="text" name="orderNo" readonly></td>
                     <th>사업자등록번호</th>
			         <td id="brn">
			         <input type="text" name="brn" >
		            <!--    
		               <select name="brn">
		                   <option value="">업체 선택</option>
		                   <option th:each="company : ${company}"
		                           th:value="${company.brn}"
		                           th:text="${company.brn}">
		                   </option>
		               </select> -->
			         </td>
                  </tr>
                  <tr>
                     <th>발신처</th>
                     <td><b>(주) SOFT-SYNC</b></td>
                     <th>수신처</th>
                     <td><input type="text" name="company_name" readonly></td>
                  </tr>
                  <tr>
                     <th>연락처</th>
                     <td>031-5555-5555</td>
                     <th>대표자명</th>
                     <td><input type="text" name="company_ceo" readonly></td>
                  </tr>
                  <tr>
                     <th>발주일</th>
                     <td><input type="text" name="orderDate" id="orderDate" readonly></td>
                     <th>주소</th>
                     <td><input type="text" name="company_address" readonly></td>
                  </tr>
                  <tr>
                     <th>납기일</th>
                     <td id="leadTimeCell" ><input type="text" name="receiveDuedate" readonly></td>
                     <th>담당자</th>
                     <td><input type="text" name="manager" readonly></td>
                  </tr>
                  <tr>
                     <th>지불조건</th>
                     <td> 내규에 따름</td>
                     <th>연락처</th>
                     <td><input type="text" name="manager_tel" readonly></td>
                  </tr>
                  </tbody>
			</table>
			<table class="listTable" id="2">
				<tr>
					<th>번호</th>
					<th>품명</th>
					<th>재질</th>
					<th>규격</th>
					<th>단위</th>
					<th>수량</th>
					<th>단가</th>
					<th>공급가액</th>
					<th>비고</th>
				</tr>
				<tr>
					<td>1</td>
					<td id = "itemNameCell"><input type="text" name="itemName" readonly></td>
					<td id = "itemMaterialCell"><input type="text" name="material" readonly></td>
					<td id = "itemDimensionsCell"><input type="text" name="dimensions" readonly></td>
					<td>EA</td>
					<td id = "orderQuantityCell"> <input type="number"  name="orderQuantity"></td>
					<td id = "unitPriceCell"><input type="text" name ="unitPrice"></td>
					<td id ="totalPriceCell"><input type="text" name ="totalPrice" readonly></td>
					<td id = "orderNote"><input type="text" name="orderNote"></td>
				</tr>
			</table>
		</form>
		</div>
		<div id="row2">
			<div id="ordersList">
				<h2 class="visual-title">계약관리</h2>
				<div class="search-container">
					<input type="date"> ~ <input type="date">
					<button type="submit" class="blueBtn">검색</button>
					<a href="purchase_order_list">
						<button type="button" class="blueBtn">목록</button>
					</a>
				</div>
				<table class="listTable" id="3">
						<colgroup>
						<col width="15%">
						<col width="15%">
						<col width="12%">
						<col width="12%">
						<col width="12%">
						<col width="13%">
						<col width="13%">
						<col width="8%">
						</colgroup>
						<tr id="item">
							<th>품목코드</th>
							<th>품목명</th>
							<th>재질</th>
							<th>규격</th>
							<th>발주수량</th>
							<th>발주일</th>
							<th colspan ="2">납기일</th>
						</tr>

				    <th:block th:each="item, itemIndex: ${items}">
					    <tr>
			              <td th:text="${item.itemCode}">품목코드</td>
			              <td th:text="${item.itemName}">품목명</td>
			              <td th:text="${item.material}">재질</td>
			              <td th:text="${item.dimensions}">규격</td>
			              <td>N/A</td>
			              <td>N/A</td>
			              <td>
			              	<span th:each="contract : ${item.contracts}" th:text="${contract.lead_time}">N/A</span>
			              	</td>
			              <td><button id="addBtn" class="blueBtn">추가</button></td>
			          	</tr>
			          	<tr id="orders" th:each="order : ${item.orders}">
			              <td th:text="${item.itemCode}">품목코드</td>
			              <td th:text="${item.itemName}">품목명</td>
			              <td th:text="${item.material}">재질</td>
			              <td th:text="${item.dimensions}">규격</td>
		               	  <td th:text="${order.orderQuantity}">발주수량</td>
			              <td th:text="${order.orderDate}">발주일</td>
			              <td th:text="${order.contract.leadTime}">납기일</td>
			              <td><button class="blueBtn" id="orderedBtn">완료</button></td>
			          	</tr>
					</th:block>				
				</table>
			</div>
		</div>
	</div>
	   
	<!-- 모달 오픈화면 -->
<div id="modalWrap">
		<div id="modalBody">
			<button type="button" class="closeBtn">&times;</button>
			<div>
				<table>
					<colgroup>
					<col width="10%">
					<col width="40%">
					<col width="10%">
					<col width="40%">
					</colgroup>
					<tbody>
						<tr>
							<td colspan="2" style="text-align:center;"><h1>발주서</h1></td>
							<th>결재란</th>
							<td></td>
						</tr>
						<tr>
							<td colspan="4" style="text-align:center;"> 
							
		   				      년      월      일<br>
	     				    	아래와 같이 발주합니다.
							</td>
						</tr>
						<tr>
							<th>사업자번호</th>
							<td></td>
							<th>발주번호</th>
							<td></td>
						</tr>
						<tr>
							<th>상호</th>
							<td></td>
							<th>대표자성명</th>
							<td></td>
						</tr>
						<tr>
							<th>주소</th>
							<td colspan="3"></td>
						</tr>
						<tr>
							<th>전화번호</th>
							<td></td>
							<th>이메일</th>
							<td></td>
						</tr>
					</tbody>
				</table>
				
				<table>
				<colgroup>
					<col width="5%">
					<col width="30%">
					<col width="15%">
					<col width="25%">
					<col width="25%">
				</colgroup>
				<tbody>
					<tr>
						<th>No</th>
						<th>품명</th>
						<th>수량</th>
						<th>단가</th>
						<th>기타</th>
					</tr>
					<tr>
						<td>1</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>2</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>3</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>4</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>5</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>6</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>7</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>8</td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>비고</td>
						<td colspan="4"></td>
					</tr>
				</tbody>
			</table>
			</div>
		<button type="submit" class="blueBtn">인쇄</button>
		<button type="submit" class="blueBtn">발주</button>
	</div>
</div>

<script>
	const popupBtn = document.getElementById("popupBtn"); // 팝업 버튼 요소 가져오기
	const modalWrap = document.getElementById("modalWrap"); // 모달 요소 가져오기
	const closeBtn = document.querySelector(".closeBtn"); // 모달 닫기 버튼 요소 가져오기
	const modalImage = document.getElementById("modalImage");
	
	// 팝업 버튼 클릭 시 모달 열기
	popupBtn.addEventListener("click", function() {
	  modalWrap.style.display = "block";
	});
	
	// 모달 닫기 버튼 클릭 시 모달 닫기
	closeBtn.addEventListener("click", function() {
	  modalWrap.style.display = "none";
	});
	
	// 모달 외부 클릭 시 모달 닫기
	window.addEventListener("click", function(event) {
	  if (event.target === modalWrap) {
	    modalWrap.style.display = "none";
	  }
	});
</script>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
	$(document).ready(function() {
	  $('#3').on('click', 'button#addBtn', function() {
	    var $row = $(this).closest('tr');
	    var itemName = $row.find('td:nth-child(2)').text();
	    var itemMaterial = $row.find('td:nth-child(3)').text();
	    var itemDimensions = $row.find('td:nth-child(4)').text();
	    var leadTime = $row.find('td:nth-child(7)').text();
	    
	    $('#itemNameCell input').val(itemName);
	    $('#itemMaterialCell input').val(itemMaterial);
	    $('#itemDimensionsCell input').val(itemDimensions);
	    $('#leadTimeCell input').val(leadTime);
	    
	    receiveDuedate
	  });
	});
	  $(document).ready(function() {
          // 계약 및 회사 정보로폼 채우기
          function populateForm(data) {
              var contract = data.contract;
              var company = data.company;

              $('input[name="orderNo"]').val(contract.orderNo);
              $('input[name="brn"]').val(company.brn);
              $('input[name="company_name"]').val(company.companyName);
              $('input[name="company_ceo"]').val(company.ceoName);
              $('input[name="orderDate"]').val(contract.orderDate);
              $('input[name="companyAddress"]').val(company.address);
              $('input[name="receiveDuedate"]').val(contract.dueDate);
              $('input[name="manager"]').val(company.manager);
              $('input[name="manager_tel"]').val(company.managerTel);
              $('input[name="itemName"]').val(contract.itemName);
              $('input[name="material"]').val(contract.material);
              $('input[name="dimensions"]').val(contract.dimensions);
              $('input[name="orderQuantity"]').val(contract.orderQuantity);
              $('input[name="unitPrice"]').val(contract.unitPrice);
              $('input[name="totalPrice"]').val(contract.totalPrice);
              $('input[name="orderNote"]').val(contract.note);
          }

         
      });
</script>
<script>

        
        // 상단 테이블정보
        $('#orderList table').on('click', '#orderedBtn', function(){
            // 완료행에서 발주정보 가져오기
            var itemName = $(this).find('td:eq(1)').text().trim();
            var material = $(this).find('td:eq(2)').text().trim(); //재질
            var dimensions = $(this).find('td:eq(3)').text().trim(); //규격
            
            // 상단 테이블의 정보 넣기
            $('#itemNameCell input[name="itemName"]').val(itemName);
            $('#itemMaterialCell input[name="material"]').val(material);
            $('#itemDimensionsCell input[name="dimensions"]').val(dimensions);
           
        });
       //  *****************************************************************
        // 상단 테이블의 계약 행 대한 클릭 이벤트 처리 
        $('#orderList table#3 tr').click(function() {
            // 클릭한 행에서 계약정보 가져오기
            var itemCode = $(this).find('td:eq(0)').text().trim();
            var itemName = $(this).find('td:eq(1)').text().trim();
            var material = $(this).find('td:eq(2)').text().trim(); //재질
            var dimensions = $(this).find('td:eq(3)').text().trim(); //규격
            var orderQuantity = $(this).find('td:eq(4)').text().trim();
            var orderDate = $(this).find('td:eq(5)').text().trim();
            var procDuedate = $(this).find('td:eq(6)').text().trim();
/*             var conYn = $(this).find('td:eq(7)').text().trim(); */
            
         /*    //계약 완료시 조회만 되게함 .prop
            var ConBool = false;
            if (conYn === 'y'){
            	ConBool = true;
            	  $('#buttonContainer').hide();  //계약완료시  저장, 초기화버튼 감추기
            }
            else{
            	 $('#buttonContainer').show();
            } */
            
            // 해당 정보를 상단의 입력 필드에 넣기
            $('#itemCodeCell input[name="itemCode"]').val(itemCode).prop('readonly', ConBool);
            $('#itemNameCell input[name="itemName"]').val(itemName).prop('readonly', ConBool);
            $('#brn input[name="brn"]').val(brn).trigger('change').prop('readonly', ConBool);
            $('#unitPriceCell input[name="price"]').val(unitPrice).prop('readonly', ConBool);
            $('#leadTimeCell input[name="leadTime"]').val(leadTime).prop('readonly', ConBool);
            $('#contractNote input[name="contractNote"]').val(contractNote).prop('readonly', ConBool);
            
            
        });
    });
</script>
	
	<!-- brn을 통해 업체명/계좌/비고를 불러옴(제이쿼리) -->
	<script type="text/javascript">
		$(document).ready(function() {
		    $('input[name="brn"]').on('change', function(event) { 
		        var brn = $(this).val(); 
		        if (brn !== '') { 
		            $.ajax({
		                url: '/getCompanyInfo', // 서버의 컨트롤러 경로
		                type: 'POST',
		                contentType: 'application/json',
		                data: JSON.stringify({ brn: brn }), // 사업자번호를 JSON 형식으로 전송
		                success: function(response) {
		                    // 서버로부터 받은 데이터를 화면에 표시
		                    $('input[name="company_name"]').val(response.company_name);
		                    $('input[name="manager"]').val(response.manager);
		                    $('input[name="company_ceo"]').val(response.company_ceo);
		                    $('input[name="company_address"]').val(response.company_address);
		                    $('input[name="manager_tel"]').val(response.manager_tel);
		                }
		            });
		        }
		    });
		});
	</script>
	
	
	<script>
    // 현재 날짜를 가져오는 함수
    function getCurrentDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 1을 더해줍니다.
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // 페이지가 로드될 때 실행되는 함수
    window.onload = function() {
        const orderDateInput = document.getElementById('orderDate');
        // 현재 날짜를 가져와서 입력란에 설정
        orderDateInput.value = getCurrentDate();
    };
</script>
	
</body>
</html>